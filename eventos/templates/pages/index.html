{% extends 'base.html' %}

{% block content %}
<div class="container">
    <h1>Bem-vindo ao Sistema de Eventos</h1>

    <div class="welcome-content">
        <p>Plataforma para conectar organizadores de eventos e fornecedores de servi√ßos.</p>

        {% if is_fornecedor %}
        <div class="fornecedor-actions">
            <h2>√Årea do Fornecedor</h2>
            <p>Gerencie seus servi√ßos e conecte-se com organizadores de eventos.</p>
            <a href="{% url 'meus_servicos' %}" class="btn btn-primary">Meus Servi√ßos</a>
            <a href="{% url 'configurar_raio_cobertura' %}" class="btn-secondary">‚öôÔ∏è Configurar Raio de Cobertura</a>
            <a href="{% url 'minhas_solicitacoes_fornecedor' %}" class="btn btn-info">üí∞ Minhas Solicita√ß√µes de Or√ßamento</a>
            <a href="{% url 'agenda' %}" class="btn btn-warning">üìÖ Minha Agenda</a>
            
            <!-- Calend√°rio em Miniatura -->
            <div class="calendar-miniature">
                <h3>üìÖ Pr√≥ximos Eventos</h3>
                <div id="calendar-mini" class="calendar-mini-container"></div>
                <div id="upcoming-events" class="upcoming-events">
                    <p class="loading">Carregando eventos...</p>
                </div>
            </div>
            
            <h3 class="mt-4">Todos os Eventos Dispon√≠veis</h3>
            {% if eventos %}
            <div class="list-group">
                {% for evento in eventos %}
                <div class="list-group-item">
                    <h5><a href="{% url 'detalhes_evento' evento.id %}">{{ evento.nomeEvento }}</a></h5>
                    <p><strong>Data:</strong> {{ evento.dataEvento|date:"d/m/Y H:i" }}</p>
                    <p><strong>Local:</strong> {{ evento.localEvento }}</p>
                    {% if evento.endereco_completo %}
                    <p><strong>Endere√ßo:</strong> {{ evento.endereco_completo }}</p>
                    {% endif %}
                    {% if evento.previsao_participantes %}
                    <p><strong>Previs√£o de Participantes:</strong> {{ evento.previsao_participantes }} pessoas</p>
                    {% endif %}
                    <p>{{ evento.descricaoEvento }}</p>
                    <p><small>Organizador: {{ evento.idUsuario.user.get_full_name }}</small></p>
                    <a href="{% url 'detalhes_evento' evento.id %}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-eye"></i> Detalhes
                    </a>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p>N√£o h√° eventos cadastrados no momento.</p>
            {% endif %}
        </div>
        {% endif %}

        {% if is_organizador %}
        <div class="organizador-actions">
            <h2>√Årea do Organizador</h2>
            <p>Encontre fornecedores e organize seus eventos.</p>
            <a href="{% url 'criar_evento' %}" class="btn btn-success">Criar Novo Evento</a>
            <a href="{% url 'todos_servicos' %}" class="btn btn-primary">Ver Todos os Servi√ßos</a>
            <a href="{% url 'minhas_solicitacoes_organizador' %}" class="btn btn-info">üí∞ Minhas Solicita√ß√µes de Or√ßamento</a>
            <a href="{% url 'agenda' %}" class="btn btn-warning">üìÖ Minha Agenda</a>
            
            <!-- Calend√°rio em Miniatura -->
            <div class="calendar-miniature">
                <h3>üìÖ Pr√≥ximos Eventos</h3>
                <div id="calendar-mini" class="calendar-mini-container"></div>
                <div id="upcoming-events" class="upcoming-events">
                    <p class="loading">Carregando eventos...</p>
                </div>
            </div>
            
            <h3 class="mt-4">Meus Eventos</h3>
            {% if eventos %}
            <div class="list-group">
                {% for evento in eventos %}
                <div class="list-group-item">
                    <h5><a href="{% url 'detalhes_evento' evento.id %}">{{ evento.nomeEvento }}</a></h5>
                    <p><strong>Data:</strong> {{ evento.dataEvento|date:"d/m/Y H:i" }}</p>
                    <p><strong>Local:</strong> {{ evento.localEvento }}</p>
                    {% if evento.endereco_completo %}
                    <p><strong>Endere√ßo:</strong> {{ evento.endereco_completo }}</p>
                    {% endif %}
                    {% if evento.previsao_participantes %}
                    <p><strong>Previs√£o de Participantes:</strong> {{ evento.previsao_participantes }} pessoas</p>
                    {% endif %}
                    <p>{{ evento.descricaoEvento }}</p>
                    <div class="mt-2">
                        <a href="{% url 'editar_evento' evento.id %}" class="btn btn-sm btn-primary">Editar</a>
                        <a href="{% url 'excluir_evento' evento.id %}" class="btn btn-sm btn-danger">Excluir</a>
                        <a href="{% url 'detalhes_evento' evento.id %}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-eye"></i> Detalhes
                        </a>
                        <a href="{% url 'todos_fornecedores'  %}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-eye"></i> Avaliar Fornecedor
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p>Voc√™ ainda n√£o criou nenhum evento.</p>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<style>
    .calendar-miniature {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 20px;
        margin: 20px 0;
        border-left: 4px solid #ffc107;
        width: 50%;
        max-width: 500px;
    }
    
    .calendar-miniature h3 {
        margin-top: 0;
        color: #333;
        font-size: 18px;
        margin-bottom: 15px;
    }
    
    .calendar-mini-container {
        height: 250px;
        margin-bottom: 15px;
        width: 100%;
    }
    
    .upcoming-events {
        border-top: 1px solid #eee;
        padding-top: 15px;
    }
    
    .upcoming-events .loading {
        text-align: center;
        color: #666;
        font-style: italic;
    }
    
    .event-item {
        display: flex;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .event-item:last-child {
        border-bottom: none;
    }
    
    .event-color {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 10px;
        flex-shrink: 0;
    }
    
    .event-info {
        flex: 1;
    }
    
    .event-title {
        font-weight: 500;
        color: #333;
        margin: 0;
        font-size: 14px;
    }
    
    .event-date {
        color: #666;
        font-size: 12px;
        margin: 0;
    }
    
    .event-type {
        background: #f8f9fa;
        color: #666;
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 10px;
        margin-left: 10px;
    }
    
    .no-events {
        text-align: center;
        color: #666;
        font-style: italic;
        padding: 20px;
    }
    
    /* Estilos do FullCalendar em miniatura */
    .fc-mini {
        font-size: 12px;
    }
    
    .fc-mini .fc-toolbar-title {
        font-size: 14px !important;
    }
    
    .fc-mini .fc-button {
        font-size: 11px !important;
        padding: 4px 8px !important;
    }
    
    .fc-mini .fc-event {
        font-size: 10px !important;
        padding: 1px 2px !important;
    }
    
    .fc-mini .fc-daygrid-day-number {
        font-size: 11px !important;
    }
    
    .fc-mini .fc-col-header-cell {
        font-size: 10px !important;
    }
    
    /* Responsividade para o calend√°rio em miniatura */
    @media (max-width: 768px) {
        .calendar-miniature {
            width: 100%;
            max-width: none;
        }
        
        .calendar-mini-container {
            height: 200px;
        }
        
        .fc-mini .fc-toolbar-title {
            font-size: 12px !important;
        }
        
        .fc-mini .fc-button {
            font-size: 10px !important;
            padding: 3px 6px !important;
        }
    }
</style>

<!-- FullCalendar CDN para miniatura -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.17/index.global.min.js'></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar calend√°rio em miniatura
        inicializarCalendarioMiniatura();
        
        // Carregar pr√≥ximos eventos
        carregarProximosEventos();
    });
    
    function inicializarCalendarioMiniatura() {
        const calendarEl = document.getElementById('calendar-mini');
        if (!calendarEl) return;
        
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'pt-br',
            headerToolbar: {
                left: 'prev,next',
                center: 'title',
                right: 'today'
            },
            buttonText: {
                today: 'Hoje'
            },
            height: 250,
            editable: false,
            selectable: false,
            dayMaxEvents: 2,
            weekends: true,
            
            // Carregar eventos
            events: function(info, successCallback, failureCallback) {
                fetch('/agenda/compromissos/')
                .then(response => response.json())
                .then(data => {
                    const eventos = data.map(evento => {
                        // Se √© um compromisso compartilhado, usar cor especial
                        let backgroundColor = evento.backgroundColor;
                        let borderColor = evento.borderColor;
                        
                        if (evento.extendedProps && evento.extendedProps.compartilhado) {
                            backgroundColor = '#ff9800'; // Laranja para compromissos compartilhados
                            borderColor = '#ff9800';
                        }
                        
                        return {
                            ...evento,
                            backgroundColor: backgroundColor,
                            borderColor: borderColor
                        };
                    });
                    successCallback(eventos);
                })
                .catch(error => {
                    console.error('Erro ao carregar eventos:', error);
                    failureCallback(error);
                });
            },
            
            // Clicar em evento
            eventClick: function(arg) {
                // Redirecionar para a agenda completa em vez de tentar abrir detalhes
                window.location.href = '/agenda/';
            },
            
            // Clicar em data
            dateClick: function(arg) {
                window.location.href = '/agenda/';
            }
        });
        
        calendar.render();
        
        // Adicionar classe para estilos espec√≠ficos
        calendarEl.classList.add('fc-mini');
    }
    
    function carregarProximosEventos() {
        const upcomingEventsEl = document.getElementById('upcoming-events');
        if (!upcomingEventsEl) return;
        
        fetch('/agenda/compromissos-miniatura/')
        .then(response => response.json())
        .then(data => {
            if (data.length === 0) {
                upcomingEventsEl.innerHTML = '<p class="no-events">Nenhum evento agendado para os pr√≥ximos dias.</p>';
                return;
            }
            
            let html = '';
            data.forEach(evento => {
                let compartilhadoInfo = '';
                if (evento.compartilhado) {
                    if (evento.fornecedor_nome && evento.organizador_nome) {
                        compartilhadoInfo = `<small style="color: #007bff; font-size: 11px;">Compartilhado: ${evento.fornecedor_nome} ‚Üî ${evento.organizador_nome}</small>`;
                    }
                }
                
                html += `
                    <div class="event-item">
                        <div class="event-color" style="background-color: ${evento.cor}"></div>
                        <div class="event-info">
                            <p class="event-title">${evento.titulo}</p>
                            <p class="event-date">${evento.data_inicio}</p>
                            ${compartilhadoInfo}
                        </div>
                        <span class="event-type">${evento.tipo}</span>
                    </div>
                `;
            });
            
            // Adicionar link para a agenda completa
            html += `
                <div style="text-align: center; margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                    <a href="{% url 'agenda' %}" class="btn btn-sm btn-outline-primary">Ver Agenda Completa</a>
                </div>
            `;
            
            upcomingEventsEl.innerHTML = html;
        })
        .catch(error => {
            console.error('Erro ao carregar eventos:', error);
            upcomingEventsEl.innerHTML = '<p class="no-events">Erro ao carregar eventos.</p>';
        });
    }
</script>
{% endblock %}