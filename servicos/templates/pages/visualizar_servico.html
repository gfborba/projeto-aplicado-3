{% extends 'base.html' %}

{% block content %}
    <div class="container">
        <div class="servico-header">
            <h1>{{ servico.nome }}</h1>
            <div class="servico-status">
                <span class="status ativo">Dispon√≠vel</span>
            </div>
        </div>
        
        <div class="fornecedor-info">
            <h3>Informa√ß√µes do Fornecedor</h3>
            <p><strong>Nome:</strong> {{ servico.fornecedor.user.get_full_name|default:servico.fornecedor.user.username }}</p>
            <p><strong>Categoria:</strong> {{ servico.fornecedor.get_categoria_display }}</p>
            <p><strong>Telefone:</strong> {{ servico.fornecedor.telefone }}</p>
            <p><strong>Endere√ßo:</strong> {{ servico.fornecedor.endereco_completo }}</p>
            
            {% if servico.fornecedor.latitude and servico.fornecedor.longitude %}
            <div class="mapa-section">
                <h4>Localiza√ß√£o</h4>
                <div id="map" style="width: 100%; height: 300px; border-radius: 8px; margin-top: 10px;"></div>
            </div>
            {% endif %}
        </div>
        
        <div class="servico-content">
            <div class="servico-info">
                <h3>Descri√ß√£o</h3>
                <p>{{ servico.descricao }}</p>
            </div>
            
            {% if servico.tags %}
            <div class="servico-tags">
                <h3>Tags</h3>
                <div class="tags-list">
                    {% for tag in servico.get_tags_list %}
                        <span class="tag">{{ tag }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            {% if servico.imagens.exists %}
            <div class="servico-imagens">
                <h3>Fotos do Servi√ßo</h3>
                <div class="imagens-grid">
                    {% for imagem in servico.imagens.all %}
                        <div class="imagem-item">
                            <img src="{{ imagem.imagem.url }}" alt="{{ imagem.legenda|default:'Imagem do servi√ßo' }}" style="max-width: 200px; height: auto;">
                            {% if imagem.legenda %}
                                <p>{{ imagem.legenda }}</p>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <div class="servico-meta">
                <p><strong>Criado em:</strong> {{ servico.data_criacao|date:"d/m/Y H:i" }}</p>
                <p><strong>√öltima atualiza√ß√£o:</strong> {{ servico.data_atualizacao|date:"d/m/Y H:i" }}</p>
            </div>
        </div>
        
        <div class="itens-section">
            <h3>Itens do Servi√ßo ({{ servico.total_itens }})</h3>
            
            <div id="lista-itens" class="itens-lista">
                {% for item in servico.itens.all %}
                    <div class="item-card">
                        <div class="item-info">
                            <h4>{{ item.nome }}</h4>
                            {% if item.descricao %}
                                <p>{{ item.descricao }}</p>
                            {% endif %}
                            {% if item.imagem %}
                                <img src="{{ item.imagem.url }}" alt="{{ item.nome }}" style="max-width: 100px; height: auto;">
                            {% endif %}
                        </div>
                    </div>
                {% empty %}
                    <p class="empty-items">Nenhum item cadastrado ainda.</p>
                {% endfor %}
            </div>
        </div>
        
        <div class="servico-actions">
            <a href="{% url 'chat_room' servico.fornecedor.user.username %}" class="btn-primary">üí¨ Conversar com Fornecedor</a>
            <a href="{% url 'todos_servicos' %}" class="btn-secondary">‚Üê Voltar aos Servi√ßos</a>
        </div>
    </div>

    {% if servico.fornecedor.latitude and servico.fornecedor.longitude %}
    <script type="text/javascript">
        (g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.${c}apis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})({
            key: "{{ google_maps_api_key }}",
            v: "weekly",
        });
        
        async function initMap() {
            // A localiza√ß√£o do fornecedor
            const position = { 
                lat: parseFloat("{{ servico.fornecedor.latitude }}"), 
                lng: parseFloat("{{ servico.fornecedor.longitude }}") 
            };
            
            // Request needed libraries.
            const { Map } = await google.maps.importLibrary("maps");
            const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
            
            // O mapa, centralizado na posi√ß√£o do fornecedor
            const map = new Map(document.getElementById("map"), {
                zoom: 15,
                center: position,
                mapId: "DEMO_MAP_ID",
            });
            
            // O marcador, posicionado na localiza√ß√£o do fornecedor
            const marker = new AdvancedMarkerElement({
                map: map,
                position: position,
                title: "{{ servico.fornecedor.user.get_full_name|default:servico.fornecedor.user.username }}",
            });
        }
        
        initMap();
    </script>
    {% endif %}
{% endblock %}